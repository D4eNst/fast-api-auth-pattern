<!DOCTYPE html>
<html>
<head>
    <title>Login Page</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title text-center">Login</h2>
                        <form id="myForm">
                            {% if errors %}
                                <div class="alert alert-danger" role="alert">
                                    {{ errors }}
                                </div>
                            {% endif %}
                            <div class="form-group col-md-6 d-flex align-items-center" >
                                <label for="_username" >Username:
                                    <input id="_username" type="text" class="form-control" style="margin-left: 5px" name="username" required>
                                </label>
                            </div>
                            <div class="form-group col-md-6 d-flex align-items-center mt-3">
                                <label for="_password">Password:
                                    <input id="_password" type="password" class="form-control" style="margin-left: 8px" name="password" required>
                                </label>
                            </div>
                            <div class="form-group col-md-6 d-flex align-items-center mt-3">
                                <label for="_next_url">
                                    <input id="_next_url" type="hidden" class="form-control" style="margin-left: 8px" name="next_url" value="{{next_url}}" required>
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block mt-3">Login</button>
                        </form>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            let form = document.getElementById('myForm');
            let username = document.getElementById("_username")
            let password = document.getElementById('_password')
            form.addEventListener('submit', function(event) {

                event.preventDefault(); // Предотвращаем стандартное поведение отправки формы

                // Проверяем условие
                if ({{is_main_app}}) {
                // if ("1" === "2") {
                    sendPostRequest('http://localhost:8000/api/auth/token' + '{{next_url}}', username.value, password.value);
                } else {
                    // Выводим окно с подтверждением
                    let userConfirmation = confirm('Вы разрешаете приложению {{app}} доступ к вашим данным?');

                    if (userConfirmation) {
                        sendPostRequest('http://localhost:8000/api/auth/token' + '{{next_url}}', username.value, password.value);
                    } else {
                        // Пользователь отменил, выполните необходимые действия
                    }
                }


            });

            function sendPostRequest(url, username, password) {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', url, true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

                 // Добавляем обработчик события для обработки ответа
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        // Обработка ответа в формате JSON
                        let jsonResponse = JSON.parse(xhr.responseText);
                        redirectToGetRequest(jsonResponse.access_token);

                        // В этом месте вы можете выполнить дополнительные действия с полученными данными
                    }
                };

                // Посылаем запрос
                var formData = "username=" + encodeURIComponent(username) +
                   "&password=" + encodeURIComponent(password);
                xhr.send(formData);
            }
            // function redirectToGetRequest(accessToken) {
            //     // Дополнительные действия перед перенаправлением пользователя (если необходимо)
            //
            //     // Перенаправление пользователя с использованием access token в заголовке "Authorization"
            //     window.location.href = "/api/auth/authorize" + "{{next_url}}" + "&access_token=" + accessToken; // Замените на фактический URL
            // }
            function redirectToGetRequest(accessToken) {
                let xhr = new XMLHttpRequest();


                let params = "{{next_url}}".replaceAll("amp;", "")

                xhr.open('GET', "/api/auth/authorize" + params, true);
                xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        let jsonResponse = JSON.parse(xhr.responseText);
                        window.location.href = jsonResponse.redirect_uri
                    }
                };

                xhr.send();
            }
        });
    </script>
</body>
</html>
